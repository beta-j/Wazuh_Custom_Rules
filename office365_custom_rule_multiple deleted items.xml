<!-- This is a custom rule for Wazuh to detect logs for multiple "SoftDelete" operations generated by the office365 API integration -->
<!-- The idea is to generate an alert when multiple emails are deleted from a given user's "deleted items" folder in a short time frame -->
<!-- This could indicate a possible account compromise and warrants further inveestigation by the SOC team -->

<group name="office365,">
  <rule id="100005" level="3">  <!-- match on user deletes an email from the deleted items folder - i.e. soft delete -->
    <if_sid>91535</if_sid>
    <field name="office365.Operation">SoftDelete</field>
    <description>Soft delete detected (direct match)</description>
  </rule>
  <rule id="100006" level="8" frequency="5" timeframe="1200">  <!-- generate an alert if more than 5 softdelete events are recorded in 20 minutes-->
    <if_matched_sid>100005</if_matched_sid>
    <same_field>office365.UserId</same_field>
    <description>Multiple Soft deletes detected from the same user</description>
  </rule>
  
  <!-- this was an attempt to detect when a user selects multiple emails and delets them in a single "softdelete" action, but it's not working yet
  <rule id="100007" level="9">
    <if_sid>100005</if_sid>
    <field name="office365.AffectedItems[5]">exists</field>
    <description>User deleted 6 or more emails in a single action</description>
  </rule>
  -->
  
  <rule id="100008" level="11" frequency="20" timeframe="1200">  <!-- generate a higher-level alert if more than 20 softdelete events are recorded in 20 minutes-->
    <if_matched_sid>100005</if_matched_sid>
    <same_field>office365.UserId</same_field>
    <description>Very Large Amount of Soft deletes detected from the same user</description>
    <options>alert_by_email</options>
  </rule>
</group>
